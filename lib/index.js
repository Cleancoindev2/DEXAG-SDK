"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.DEXAG=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_objectSpread2=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_ethers=require("ethers"),_validate=_interopRequireDefault(require("./services/validate")),_trading=_interopRequireDefault(require("./services/trading")),_utility=_interopRequireDefault(require("./services/utility")),DEXAG=/*#__PURE__*/function(){function a(){(0,_classCallCheck2["default"])(this,a),window.web3||(window.web3={});var b=window.web3.currentProvider;b&&(// exit if no web3 found
this.provider=new _ethers.ethers.providers.Web3Provider(b),this.signer=this.provider.getSigner(),window.web3StatusHandler=function(){})}return(0,_createClass2["default"])(a,[{key:"sendTrade",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e,f,g,h,i,j,k;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(d=_ethers.ethers.utils.bigNumberify(b.trade.value),e={},f={to:b.trade.to,data:b.trade.data,value:d,gasLimit:5e5},"bancor"==c.dex){a.next=11;break}return window.web3StatusHandler("init"),a.next=7,_trading["default"].getGas();case 7:g=a.sent,f.gasPrice=g,a.next=13;break;case 11:window.web3StatusHandler("bancor_notice"),f.gasPrice=_ethers.ethers.utils.bigNumberify(b.metadata.gasPrice);case 13:return a.prev=13,a.next=16,this.signer.getAddress();case 16:return h=a.sent,i=(0,_objectSpread2["default"])({},f,{from:h}),a.next=20,this.provider.estimateGas(i);case 20:j=a.sent,f.gasLimit=1.2*parseInt(j.toString()),a.next=28;break;case 24:return a.prev=24,a.t0=a["catch"](13),window.web3StatusHandler("bad_tx"),a.abrupt("return");case 28:return a.prev=28,a.next=31,this.signer.sendTransaction(f);case 31:e=a.sent,a.next=43;break;case 34:if(a.prev=34,a.t1=a["catch"](28),window.ethereum.isImToken){a.next=39;break}return window.web3StatusHandler("rejected"),a.abrupt("return");case 39:if(1001!=a.t1.errorCode){a.next=42;break}return window.web3StatusHandler("rejected"),a.abrupt("return");case 42:"string"==typeof a.t1.transactionHash&&(e.hash=a.t1.transactionHash);case 43:return window.web3StatusHandler("send_trade",e.hash),a.next=46,_utility["default"].waitForReceipt(e.hash,this.provider);case 46:k=a.sent,_utility["default"].track(e,c,b),_utility["default"].handleReceipt(e,k);case 49:case"end":return a.stop();}},a,this,[[13,24],[28,34]])}));return function sendTrade(){return a.apply(this,arguments)}}()},{key:"unwrap",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){var c;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:c=_utility["default"].getWethContract(this.signer),_trading["default"].unwrap(c,b);case 2:case"end":return a.stop();}},a,this)}));return function unwrap(){return a.apply(this,arguments)}}()// Public Functions
},{key:"getTrade",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){var c,d,e,f,g;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=b.to,d=b.from,e=b.amount,f=b.dex,a.next=3,_trading["default"].getTrade({to:c,from:d,amount:e,dex:f});case 3:return g=a.sent,a.abrupt("return",g);case 5:case"end":return a.stop();}},a)}));return function getTrade(){return a.apply(this,arguments)}}()},{key:"getPrice",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){var c,d,e,f,g;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=b.to,d=b.from,e=b.amount,f=b.dex,a.next=3,_trading["default"].getPrice({to:c,from:d,amount:e,dex:f});case 3:return g=a.sent,a.abrupt("return",g);case 5:case"end":return a.stop();}},a)}));return function getPrice(){return a.apply(this,arguments)}}()},{key:"tradeOrder",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){var c,d,e,f,g,h,i;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:c=b.tx,d=c.metadata,e=d.input,f=d.output,g=d.source,h=d.query,i={pair:{base:h.to,quote:h.from},amount:h.fromAmount||h.toAmount,dex:g.dex,isBuying:!0},console.log(i),this.sendTrade(c,i);case 5:case"end":return a.stop();}},a,this)}));return function tradeOrder(){return a.apply(this,arguments)}}()},{key:"validateWeb3",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return this.provider&&(this.signer=this.provider.getSigner()),a.abrupt("return",_validate["default"].web3(b,this.provider,this.signer));case 2:case"end":return a.stop();}},a,this)}));return function validateWeb3(){return a.apply(this,arguments)}}()},{key:"registerStatusHandler",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:window.web3StatusHandler=b;case 1:case"end":return a.stop();}},a)}));return function registerStatusHandler(){return a.apply(this,arguments)}}()}]),a}();exports.DEXAG=DEXAG;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJERVhBRyIsIndpbmRvdyIsIndlYjMiLCJjdXJyZW50UHJvdmlkZXIiLCJwcm92aWRlciIsImV0aGVycyIsInByb3ZpZGVycyIsIldlYjNQcm92aWRlciIsInNpZ25lciIsImdldFNpZ25lciIsIndlYjNTdGF0dXNIYW5kbGVyIiwidHJhZGUiLCJkZXRhaWxzIiwidmFsdWUiLCJ1dGlscyIsImJpZ051bWJlcmlmeSIsInN0YXR1cyIsInR4IiwidG8iLCJkYXRhIiwiZ2FzTGltaXQiLCJkZXgiLCJ0cmFkaW5nIiwiZ2V0R2FzIiwiZmFzdF9nYXMiLCJnYXNQcmljZSIsIm1ldGFkYXRhIiwiZ2V0QWRkcmVzcyIsInNlbmRlciIsImVzdGltYXRlVHgiLCJmcm9tIiwiZXN0aW1hdGVHYXMiLCJlc3RpbWF0ZSIsInBhcnNlSW50IiwidG9TdHJpbmciLCJzZW5kVHJhbnNhY3Rpb24iLCJldGhlcmV1bSIsImlzSW1Ub2tlbiIsImVycm9yQ29kZSIsInRyYW5zYWN0aW9uSGFzaCIsImhhc2giLCJ1dGlsaXR5Iiwid2FpdEZvclJlY2VpcHQiLCJyZWNlaXB0IiwidHJhY2siLCJoYW5kbGVSZWNlaXB0IiwiYW1vdW50Iiwid2V0aENvbnRyYWN0IiwiZ2V0V2V0aENvbnRyYWN0IiwidW53cmFwIiwiZ2V0VHJhZGUiLCJnZXRQcmljZSIsImlucHV0Iiwib3V0cHV0Iiwic291cmNlIiwicXVlcnkiLCJwYWlyIiwiYmFzZSIsInF1b3RlIiwiZnJvbUFtb3VudCIsInRvQW1vdW50IiwiaXNCdXlpbmciLCJjb25zb2xlIiwibG9nIiwic2VuZFRyYWRlIiwidmFsaWRhdGUiLCJoYW5kbGVyIl0sIm1hcHBpbmdzIjoic3pCQU9hQSxLLHlCQUVYLFlBQWMseUNBQ1BDLE1BQU0sQ0FBQ0MsSUFEQSxHQUNNRCxNQUFNLENBQUNDLElBQVAsQ0FBYyxFQURwQixLQUVOQyxDQUFBQSxDQUZNLENBRWNGLE1BQU0sQ0FBQ0MsSUFGckIsQ0FF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b3J0IHZhbGlkYXRlIGZyb20gJy4vc2VydmljZXMvdmFsaWRhdGUnO1xuaW1wb3J0IHRyYWRpbmcgZnJvbSAnLi9zZXJ2aWNlcy90cmFkaW5nJztcbmltcG9ydCB1dGlsaXR5IGZyb20gJy4vc2VydmljZXMvdXRpbGl0eSc7XG5cbmV4cG9ydCBjbGFzcyBERVhBRyB7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgaWYgKCF3aW5kb3cud2ViMykgd2luZG93LndlYjMgPSB7fTtcbiAgICBsZXQgeyBjdXJyZW50UHJvdmlkZXIgfSA9IHdpbmRvdy53ZWIzO1xuICAgIGlmICghY3VycmVudFByb3ZpZGVyKSByZXR1cm47IC8vIGV4aXQgaWYgbm8gd2ViMyBmb3VuZFxuICAgIHRoaXMucHJvdmlkZXIgPSBuZXcgZXRoZXJzLnByb3ZpZGVycy5XZWIzUHJvdmlkZXIoY3VycmVudFByb3ZpZGVyKTtcbiAgICB0aGlzLnNpZ25lciA9IHRoaXMucHJvdmlkZXIuZ2V0U2lnbmVyKCk7XG4gICAgd2luZG93LndlYjNTdGF0dXNIYW5kbGVyID0gKCk9Pnt9IC8vIHByZXNldCBzdGF0dXMgaGFuZGxlclxuICB9XG5cbiAgYXN5bmMgc2VuZFRyYWRlKHRyYWRlLCBkZXRhaWxzKSB7XG4gICAgY29uc3QgdmFsdWUgPSBldGhlcnMudXRpbHMuYmlnTnVtYmVyaWZ5KHRyYWRlLnRyYWRlLnZhbHVlKTtcbiAgICBsZXQgc3RhdHVzID0ge307XG4gICAgY29uc3QgdHggPSB7XG4gICAgICB0bzogdHJhZGUudHJhZGUudG8sXG4gICAgICBkYXRhOiB0cmFkZS50cmFkZS5kYXRhLFxuICAgICAgdmFsdWU6IHZhbHVlLFxuICAgICAgZ2FzTGltaXQ6IDUwMDAwMFxuICAgIH07XG4gICAgLy8gU2V0IGdhcyBhbmQgaGFuZGxlIGJhbmNvciBleGNlcHRpb25cbiAgICBpZihkZXRhaWxzLmRleCE9J2JhbmNvcicpe1xuICAgICAgd2luZG93LndlYjNTdGF0dXNIYW5kbGVyKCdpbml0Jyk7XG4gICAgICBjb25zdCBmYXN0X2dhcyA9IGF3YWl0IHRyYWRpbmcuZ2V0R2FzKCk7XG4gICAgICB0eC5nYXNQcmljZSA9IGZhc3RfZ2FzO1xuICAgIH1lbHNle1xuICAgICAgd2luZG93LndlYjNTdGF0dXNIYW5kbGVyKCdiYW5jb3Jfbm90aWNlJyk7XG4gICAgICB0eC5nYXNQcmljZSA9IGV0aGVycy51dGlscy5iaWdOdW1iZXJpZnkodHJhZGUubWV0YWRhdGEuZ2FzUHJpY2UpO1xuICAgIH1cbiAgICAvLyBlc3RpbWF0ZSBnYXNcbiAgICB0cnl7XG4gICAgICBjb25zdCBzZW5kZXIgPSBhd2FpdCB0aGlzLnNpZ25lci5nZXRBZGRyZXNzKCk7XG4gICAgICBjb25zdCBlc3RpbWF0ZVR4ID0geyAuLi50eCwgZnJvbTogc2VuZGVyIH07XG4gICAgICBjb25zdCBlc3RpbWF0ZSA9IGF3YWl0IHRoaXMucHJvdmlkZXIuZXN0aW1hdGVHYXMoZXN0aW1hdGVUeCk7XG4gICAgICB0eC5nYXNMaW1pdCA9IHBhcnNlSW50KGVzdGltYXRlLnRvU3RyaW5nKCkpKjEuMlxuICAgIH1jYXRjaChlcnIpe1xuICAgICAgd2luZG93LndlYjNTdGF0dXNIYW5kbGVyKCdiYWRfdHgnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8gYXR0ZW1wdCBzZW5kaW5nIHRyYWRlXG4gICAgdHJ5e1xuICAgICAgc3RhdHVzID0gYXdhaXQgdGhpcy5zaWduZXIuc2VuZFRyYW5zYWN0aW9uKHR4KTtcbiAgICB9Y2F0Y2goZXJyKXtcbiAgICAgIC8vIGlzc3VlIHNlbmRpbmcgdHhcbiAgICAgIGlmKCF3aW5kb3cuZXRoZXJldW0uaXNJbVRva2VuKXtcbiAgICAgICAgd2luZG93LndlYjNTdGF0dXNIYW5kbGVyKCdyZWplY3RlZCcpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoZXJyLmVycm9yQ29kZSA9PSAxMDAxKSB7XG4gICAgICAgIHdpbmRvdy53ZWIzU3RhdHVzSGFuZGxlcigncmVqZWN0ZWQnKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaWYgKHR5cGVvZiBlcnIudHJhbnNhY3Rpb25IYXNoID09ICdzdHJpbmcnKXtcbiAgICAgICAgc3RhdHVzLmhhc2ggPSBlcnIudHJhbnNhY3Rpb25IYXNoXG4gICAgICB9XG4gICAgfVxuICAgIC8vIFRyYWRlIHNlbnRcbiAgICB3aW5kb3cud2ViM1N0YXR1c0hhbmRsZXIoJ3NlbmRfdHJhZGUnLCBzdGF0dXMuaGFzaCk7XG4gICAgY29uc3QgcmVjZWlwdCA9IGF3YWl0IHV0aWxpdHkud2FpdEZvclJlY2VpcHQoc3RhdHVzLmhhc2gsIHRoaXMucHJvdmlkZXIpO1xuICAgIHV0aWxpdHkudHJhY2soc3RhdHVzLCBkZXRhaWxzLCB0cmFkZSlcbiAgICB1dGlsaXR5LmhhbmRsZVJlY2VpcHQoc3RhdHVzLCByZWNlaXB0KTtcbiAgfVxuXG4gIGFzeW5jIHVud3JhcChhbW91bnQpIHtcbiAgICBjb25zdCB3ZXRoQ29udHJhY3QgPSB1dGlsaXR5LmdldFdldGhDb250cmFjdCh0aGlzLnNpZ25lcik7XG4gICAgdHJhZGluZy51bndyYXAod2V0aENvbnRyYWN0LCBhbW91bnQpO1xuICB9XG5cbiAgLy8gUHVibGljIEZ1bmN0aW9uc1xuXG4gIGFzeW5jIGdldFRyYWRlKHt0bywgZnJvbSwgYW1vdW50LCBkZXh9KSB7XG4gICAgY29uc3QgdHJhZGUgPSBhd2FpdCB0cmFkaW5nLmdldFRyYWRlKHt0bywgZnJvbSwgYW1vdW50LCBkZXh9KTtcbiAgICByZXR1cm4gdHJhZGVcbiAgfVxuXG4gIGFzeW5jIGdldFByaWNlKHt0bywgZnJvbSwgYW1vdW50LCBkZXh9KSB7XG4gICAgY29uc3QgdHJhZGUgPSBhd2FpdCB0cmFkaW5nLmdldFByaWNlKHt0bywgZnJvbSwgYW1vdW50LCBkZXh9KTtcbiAgICByZXR1cm4gdHJhZGVcbiAgfVxuXG4gIGFzeW5jIHRyYWRlT3JkZXIoe3R4fSkge1xuICAgIGxldCB7aW5wdXQsIG91dHB1dCwgc291cmNlLCBxdWVyeX0gPSB0eC5tZXRhZGF0YTtcbiAgICB2YXIgZGV0YWlscyA9IHtwYWlyOiB7YmFzZTpxdWVyeS50bywgcXVvdGU6cXVlcnkuZnJvbX0sIGFtb3VudDogcXVlcnkuZnJvbUFtb3VudHx8cXVlcnkudG9BbW91bnQsIGRleDogc291cmNlLmRleCwgaXNCdXlpbmc6IHRydWV9XG4gICAgY29uc29sZS5sb2coZGV0YWlscylcbiAgICB0aGlzLnNlbmRUcmFkZSh0eCwgZGV0YWlscylcbiAgfVxuXG4gIGFzeW5jIHZhbGlkYXRlV2ViMyh0cmFkZSkge1xuICAgIGlmKHRoaXMucHJvdmlkZXIpIHRoaXMuc2lnbmVyID0gdGhpcy5wcm92aWRlci5nZXRTaWduZXIoKTtcbiAgICByZXR1cm4gdmFsaWRhdGUud2ViMyh0cmFkZSwgdGhpcy5wcm92aWRlciwgdGhpcy5zaWduZXIpO1xuICB9XG5cbiAgYXN5bmMgcmVnaXN0ZXJTdGF0dXNIYW5kbGVyKGhhbmRsZXIpIHtcbiAgICB3aW5kb3cud2ViM1N0YXR1c0hhbmRsZXIgPSBoYW5kbGVyO1xuICB9XG5cbn1cbiJdfQ==