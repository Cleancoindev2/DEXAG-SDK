"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _objectSpread2=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread")),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_ethers=require("ethers"),_validate3=_interopRequireDefault(require("./services/validate")),_trading=_interopRequireDefault(require("./services/trading")),_utility=_interopRequireDefault(require("./services/utility"));// Services
function fromPrivateKey(a){var b=new _ethers.ethers.providers.InfuraProvider("homestead","135bcba44428495c86d17c754d38649d"),c=new _ethers.ethers.Wallet(a,b);return new SDK(b,c)}function fromProvider(a){var b=new _ethers.ethers.providers.Web3Provider(a),c=b.getSigner();return new SDK(b,c)}var SDK=/*#__PURE__*/function(){function a(b,c){(0,_classCallCheck2["default"])(this,a),this.provider=b,this.signer=c,this.statusHandler=function(){}}return(0,_createClass2["default"])(a,[{key:"getTrade",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){var c,d,e,f,g,h,i;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=b.to,d=b.from,e=b.fromAmount,f=b.toAmount,g=b.limitAmount,h=b.dex,a.next=3,_trading["default"].getTrade({to:c,from:d,fromAmount:e,toAmount:f,limitAmount:g,dex:h});case 3:return i=a.sent,a.abrupt("return",i);case 5:case"end":return a.stop();}},a)}));return function getTrade(){return a.apply(this,arguments)}}()},{key:"getPrice",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){var c,d,e,f,g,h;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=b.to,d=b.from,e=b.fromAmount,f=b.toAmount,g=b.dex,a.next=3,_trading["default"].getPrice({to:c,from:d,fromAmount:e,toAmount:f,dex:g});case 3:return h=a.sent,a.abrupt("return",h);case 5:case"end":return a.stop();}},a)}));return function getPrice(){return a.apply(this,arguments)}}()},{key:"trade",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){var c,d,e,f,g,h;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:c=b.metadata,d=c.input,e=c.output,f=c.source,g=c.query,h={pair:{base:g.to,quote:g.from},amount:g.fromAmount||g.toAmount,dex:f.dex,isBuying:!0},this._sendTrade(b,h);case 3:case"end":return a.stop();}},a,this)}));return function trade(){return a.apply(this,arguments)}}()},{key:"sendTrade",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:this._sendTrade(b,c);case 1:case"end":return a.stop();}},a,this)}));return function sendTrade(){return a.apply(this,arguments)}}()},{key:"validate",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",_validate3["default"].web3(b,this.provider,this.signer,this.statusHandler));case 1:case"end":return a.stop();}},a,this)}));return function validate(){return a.apply(this,arguments)}}()},{key:"registerStatusHandler",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:this.statusHandler=b;case 1:case"end":return a.stop();}},a,this)}));return function registerStatusHandler(){return a.apply(this,arguments)}}()},{key:"_sendTrade",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e,f,g,h,i,j,k;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(this.statusHandler("clear"),d=_ethers.ethers.utils.bigNumberify(b.trade.value),e={},f={to:b.trade.to,data:b.trade.data,value:d,gasLimit:5e5},"bancor"==c.dex){a.next=12;break}return this.statusHandler("init"),a.next=8,_trading["default"].getGas();case 8:g=a.sent,f.gasPrice=g,a.next=14;break;case 12:this.statusHandler("bancor_notice"),f.gasPrice=_ethers.ethers.utils.bigNumberify(b.metadata.gasPrice);case 14:return a.prev=14,a.next=17,this.signer.getAddress();case 17:return h=a.sent,i=(0,_objectSpread2["default"])({},f,{from:h}),a.next=21,this.provider.estimateGas(i);case 21:j=a.sent,f.gasLimit=1.2*parseInt(j.toString()),a.next=29;break;case 25:return a.prev=25,a.t0=a["catch"](14),this.statusHandler("bad_tx"),a.abrupt("return");case 29:return a.prev=29,a.next=32,this.signer.sendTransaction(f);case 32:e=a.sent,a.next=44;break;case 35:if(a.prev=35,a.t1=a["catch"](29),window.ethereum.isImToken){a.next=40;break}return this.statusHandler("rejected"),a.abrupt("return");case 40:if(1001!=a.t1.errorCode){a.next=43;break}return this.statusHandler("rejected"),a.abrupt("return");case 43:"string"==typeof a.t1.transactionHash&&(e.hash=a.t1.transactionHash);case 44:return this.statusHandler("send_trade",e.hash),a.next=47,this.provider.waitForTransaction(e.hash);case 47:k=a.sent,_utility["default"].track(e,c,b),_utility["default"].handleReceipt(e,k,this.statusHandler);case 50:case"end":return a.stop();}},a,this,[[14,25],[29,35]])}));return function _sendTrade(){return a.apply(this,arguments)}}()}]),a}(),DEXAG={fromPrivateKey:fromPrivateKey,fromProvider:fromProvider},_default=DEXAG;exports["default"]=_default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJmcm9tUHJpdmF0ZUtleSIsInByaXZhdGVLZXkiLCJwcm92aWRlciIsImV0aGVycyIsInByb3ZpZGVycyIsIkluZnVyYVByb3ZpZGVyIiwic2lnbmVyIiwiV2FsbGV0IiwiU0RLIiwiZnJvbVByb3ZpZGVyIiwiY3VycmVudFByb3ZpZGVyIiwiV2ViM1Byb3ZpZGVyIiwiZ2V0U2lnbmVyIiwic3RhdHVzSGFuZGxlciIsInRvIiwiZnJvbSIsImZyb21BbW91bnQiLCJ0b0Ftb3VudCIsImxpbWl0QW1vdW50IiwiZGV4IiwidHJhZGluZyIsImdldFRyYWRlIiwidHJhZGUiLCJnZXRQcmljZSIsInR4IiwibWV0YWRhdGEiLCJpbnB1dCIsIm91dHB1dCIsInNvdXJjZSIsInF1ZXJ5IiwiZGV0YWlscyIsInBhaXIiLCJiYXNlIiwicXVvdGUiLCJhbW91bnQiLCJpc0J1eWluZyIsIl9zZW5kVHJhZGUiLCJ2YWxpZGF0ZSIsIndlYjMiLCJoYW5kbGVyIiwidmFsdWUiLCJ1dGlscyIsImJpZ051bWJlcmlmeSIsInN0YXR1cyIsImRhdGEiLCJnYXNMaW1pdCIsImdldEdhcyIsImdhc1ByaWNlIiwiZ2V0QWRkcmVzcyIsInNlbmRlciIsImVzdGltYXRlVHgiLCJlc3RpbWF0ZUdhcyIsImVzdGltYXRlIiwicGFyc2VJbnQiLCJ0b1N0cmluZyIsInNlbmRUcmFuc2FjdGlvbiIsIndpbmRvdyIsImV0aGVyZXVtIiwiaXNJbVRva2VuIiwiZXJyb3JDb2RlIiwidHJhbnNhY3Rpb25IYXNoIiwiaGFzaCIsIndhaXRGb3JUcmFuc2FjdGlvbiIsInJlY2VpcHQiLCJ1dGlsaXR5IiwidHJhY2siLCJoYW5kbGVSZWNlaXB0IiwiREVYQUciXSwibWFwcGluZ3MiOiI0ekJBRUE7QUFLQSxRQUFTQSxDQUFBQSxjQUFULENBQXdCQyxDQUF4QixDQUFvQyxJQUU1QkMsQ0FBQUEsQ0FBUSxDQUFHLEdBQUlDLGdCQUFPQyxTQUFQLENBQWlCQyxj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eEMsQyxXQUNzQixLQUFLM0QsUUFBTCxDQUFjNEQsa0JBQWQsQ0FBaUNuQixDQUFNLENBQUNrQixJQUF4QyxDLFNBQWhCRSxDLFFBQ05DLG9CQUFRQyxLQUFSLENBQWN0QixDQUFkLENBQXNCYixDQUF0QixDQUErQlIsQ0FBL0IsQyxDQUNBMEMsb0JBQVFFLGFBQVIsQ0FBc0J2QixDQUF0QixDQUE4Qm9CLENBQTlCLENBQXVDLEtBQUtsRCxhQUE1QyxDLDJJQUlFc0QsS0FBSyxDQUFHLENBQ1puRSxjQUFjLENBQWRBLGNBRFksQ0FFWlMsWUFBWSxDQUFaQSxZQUZZLEMsVUFLQzBELEsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBldGhlcnMgfSBmcm9tICdldGhlcnMnO1xuXG4vLyBTZXJ2aWNlc1xuaW1wb3J0IHZhbGlkYXRlIGZyb20gJy4vc2VydmljZXMvdmFsaWRhdGUnO1xuaW1wb3J0IHRyYWRpbmcgZnJvbSAnLi9zZXJ2aWNlcy90cmFkaW5nJztcbmltcG9ydCB1dGlsaXR5IGZyb20gJy4vc2VydmljZXMvdXRpbGl0eSc7XG5cbmZ1bmN0aW9uIGZyb21Qcml2YXRlS2V5KHByaXZhdGVLZXkpIHtcbiAgY29uc3QgcHJvamVjdElkID0gJzEzNWJjYmE0NDQyODQ5NWM4NmQxN2M3NTRkMzg2NDlkJztcbiAgY29uc3QgcHJvdmlkZXIgPSBuZXcgZXRoZXJzLnByb3ZpZGVycy5JbmZ1cmFQcm92aWRlcignaG9tZXN0ZWFkJywgcHJvamVjdElkKTtcbiAgY29uc3Qgc2lnbmVyID0gbmV3IGV0aGVycy5XYWxsZXQocHJpdmF0ZUtleSwgcHJvdmlkZXIpO1xuICByZXR1cm4gbmV3IFNESyhwcm92aWRlciwgc2lnbmVyKTtcbn1cblxuZnVuY3Rpb24gZnJvbVByb3ZpZGVyKGN1cnJlbnRQcm92aWRlcikge1xuICBjb25zdCBwcm92aWRlciA9IG5ldyBldGhlcnMucHJvdmlkZXJzLldlYjNQcm92aWRlcihjdXJyZW50UHJvdmlkZXIpO1xuICBjb25zdCBzaWduZXIgPSBwcm92aWRlci5nZXRTaWduZXIoKTtcbiAgcmV0dXJuIG5ldyBTREsocHJvdmlkZXIsIHNpZ25lcik7XG59XG5cbmNsYXNzIFNESyB7XG4gIGNvbnN0cnVjdG9yKHByb3ZpZGVyLCBzaWduZXIpIHtcbiAgICB0aGlzLnByb3ZpZGVyID0gcHJvdmlkZXI7XG4gICAgdGhpcy5zaWduZXIgPSBzaWduZXI7XG4gICAgdGhpcy5zdGF0dXNIYW5kbGVyID0gKCkgPT4ge30gLy8gcHJlc2V0IHN0YXR1cyBoYW5kbGVyXG4gIH1cblxuICBhc3luYyBnZXRUcmFkZSh7dG8sIGZyb20sIGZyb21BbW91bnQsIHRvQW1vdW50LCBsaW1pdEFtb3VudCwgZGV4fSkge1xuICAgIGNvbnN0IHRyYWRlID0gYXdhaXQgdHJhZGluZy5nZXRUcmFkZSh7dG8sIGZyb20sIGZyb21BbW91bnQsIHRvQW1vdW50LCBsaW1pdEFtb3VudCwgZGV4fSk7XG4gICAgcmV0dXJuIHRyYWRlXG4gIH1cblxuICBhc3luYyBnZXRQcmljZSh7dG8sIGZyb20sIGZyb21BbW91bnQsIHRvQW1vdW50LCBkZXh9KSB7XG4gICAgY29uc3QgdHJhZGUgPSBhd2FpdCB0cmFkaW5nLmdldFByaWNlKHt0bywgZnJvbSwgZnJvbUFtb3VudCwgdG9BbW91bnQsIGRleH0pO1xuICAgIHJldHVybiB0cmFkZVxuICB9XG5cbiAgYXN5bmMgdHJhZGUodHgpIHtcbiAgICBsZXQge2lucHV0LCBvdXRwdXQsIHNvdXJjZSwgcXVlcnl9ID0gdHgubWV0YWRhdGE7XG4gICAgdmFyIGRldGFpbHMgPSB7cGFpcjoge2Jhc2U6cXVlcnkudG8sIHF1b3RlOnF1ZXJ5LmZyb219LCBhbW91bnQ6IHF1ZXJ5LmZyb21BbW91bnR8fHF1ZXJ5LnRvQW1vdW50LCBkZXg6IHNvdXJjZS5kZXgsIGlzQnV5aW5nOiB0cnVlfVxuICAgIHRoaXMuX3NlbmRUcmFkZSh0eCwgZGV0YWlscyk7XG4gIH1cblxuICBhc3luYyBzZW5kVHJhZGUodHgsIGRldGFpbHMpIHtcbiAgICB0aGlzLl9zZW5kVHJhZGUodHgsIGRldGFpbHMpO1xuICB9XG5cbiAgYXN5bmMgdmFsaWRhdGUodHgpIHtcbiAgICByZXR1cm4gdmFsaWRhdGUud2ViMyh0eCwgdGhpcy5wcm92aWRlciwgdGhpcy5zaWduZXIsIHRoaXMuc3RhdHVzSGFuZGxlcik7XG4gIH1cblxuICBhc3luYyByZWdpc3RlclN0YXR1c0hhbmRsZXIoaGFuZGxlcikge1xuICAgIHRoaXMuc3RhdHVzSGFuZGxlciA9IGhhbmRsZXI7XG4gIH1cblxuICBhc3luYyBfc2VuZFRyYWRlKHRyYWRlLCBkZXRhaWxzKSB7XG4gICAgdGhpcy5zdGF0dXNIYW5kbGVyKCdjbGVhcicpO1xuICAgIGNvbnN0IHZhbHVlID0gZXRoZXJzLnV0aWxzLmJpZ051bWJlcmlmeSh0cmFkZS50cmFkZS52YWx1ZSk7XG4gICAgbGV0IHN0YXR1cyA9IHt9O1xuICAgIGNvbnN0IHR4ID0ge1xuICAgICAgdG86IHRyYWRlLnRyYWRlLnRvLFxuICAgICAgZGF0YTogdHJhZGUudHJhZGUuZGF0YSxcbiAgICAgIHZhbHVlOiB2YWx1ZSxcbiAgICAgIGdhc0xpbWl0OiA1MDAwMDBcbiAgICB9O1xuICAgIC8vIFNldCBnYXMgYW5kIGhhbmRsZSBiYW5jb3IgZXhjZXB0aW9uXG4gICAgaWYoZGV0YWlscy5kZXghPSdiYW5jb3InKXtcbiAgICAgIHRoaXMuc3RhdHVzSGFuZGxlcignaW5pdCcpO1xuICAgICAgY29uc3QgZ2FzUHJpY2UgPSBhd2FpdCB0cmFkaW5nLmdldEdhcygpO1xuICAgICAgdHguZ2FzUHJpY2UgPSBnYXNQcmljZTtcbiAgICB9ZWxzZXtcbiAgICAgIHRoaXMuc3RhdHVzSGFuZGxlcignYmFuY29yX25vdGljZScpO1xuICAgICAgdHguZ2FzUHJpY2UgPSBldGhlcnMudXRpbHMuYmlnTnVtYmVyaWZ5KHRyYWRlLm1ldGFkYXRhLmdhc1ByaWNlKTtcbiAgICB9XG4gICAgLy8gZXN0aW1hdGUgZ2FzXG4gICAgdHJ5e1xuICAgICAgY29uc3Qgc2VuZGVyID0gYXdhaXQgdGhpcy5zaWduZXIuZ2V0QWRkcmVzcygpO1xuICAgICAgY29uc3QgZXN0aW1hdGVUeCA9IHsgLi4udHgsIGZyb206IHNlbmRlciB9O1xuICAgICAgY29uc3QgZXN0aW1hdGUgPSBhd2FpdCB0aGlzLnByb3ZpZGVyLmVzdGltYXRlR2FzKGVzdGltYXRlVHgpO1xuICAgICAgdHguZ2FzTGltaXQgPSBwYXJzZUludChlc3RpbWF0ZS50b1N0cmluZygpKSoxLjJcbiAgICB9Y2F0Y2goZXJyKXtcbiAgICAgIHRoaXMuc3RhdHVzSGFuZGxlcignYmFkX3R4Jyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIGF0dGVtcHQgc2VuZGluZyB0cmFkZVxuICAgIHRyeXtcbiAgICAgIHN0YXR1cyA9IGF3YWl0IHRoaXMuc2lnbmVyLnNlbmRUcmFuc2FjdGlvbih0eCk7XG4gICAgfWNhdGNoKGVycil7XG4gICAgICAvLyBpc3N1ZSBzZW5kaW5nIHR4XG4gICAgICBpZighd2luZG93LmV0aGVyZXVtLmlzSW1Ub2tlbil7XG4gICAgICAgIHRoaXMuc3RhdHVzSGFuZGxlcigncmVqZWN0ZWQnKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaWYgKGVyci5lcnJvckNvZGUgPT0gMTAwMSkge1xuICAgICAgICB0aGlzLnN0YXR1c0hhbmRsZXIoJ3JlamVjdGVkJyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmICh0eXBlb2YgZXJyLnRyYW5zYWN0aW9uSGFzaCA9PSAnc3RyaW5nJyl7XG4gICAgICAgIHN0YXR1cy5oYXNoID0gZXJyLnRyYW5zYWN0aW9uSGFzaFxuICAgICAgfVxuICAgIH1cbiAgICAvLyBUcmFkZSBzZW50XG4gICAgdGhpcy5zdGF0dXNIYW5kbGVyKCdzZW5kX3RyYWRlJywgc3RhdHVzLmhhc2gpO1xuICAgIGNvbnN0IHJlY2VpcHQgPSBhd2FpdCB0aGlzLnByb3ZpZGVyLndhaXRGb3JUcmFuc2FjdGlvbihzdGF0dXMuaGFzaCk7XG4gICAgdXRpbGl0eS50cmFjayhzdGF0dXMsIGRldGFpbHMsIHRyYWRlKVxuICAgIHV0aWxpdHkuaGFuZGxlUmVjZWlwdChzdGF0dXMsIHJlY2VpcHQsIHRoaXMuc3RhdHVzSGFuZGxlcik7XG4gIH1cbn1cblxuY29uc3QgREVYQUcgPSB7XG4gIGZyb21Qcml2YXRlS2V5LFxuICBmcm9tUHJvdmlkZXIsXG59O1xuXG5leHBvcnQgZGVmYXVsdCBERVhBRztcbiJdfQ==